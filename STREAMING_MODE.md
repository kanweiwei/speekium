# ğŸŒŠ Speekium æµå¼å“åº”æ¨¡å¼

åœ¨å®ˆæŠ¤è¿›ç¨‹åŸºç¡€ä¸Šå®ç°**æµå¼å“åº”**ï¼Œè®© LLM å›å¤**è¾¹ç”Ÿæˆè¾¹æ˜¾ç¤º**ï¼Œç”¨æˆ·ä½“éªŒæ›´æµç•…ï¼

## ğŸ“Š ä½“éªŒå¯¹æ¯”

| æ¨¡å¼ | é¦–å­—æ˜¾ç¤º | å®Œæ•´å“åº” | ç”¨æˆ·ä½“éªŒ |
|------|---------|---------|---------|
| **éæµå¼** | 5s å | 5s | ç­‰å¾…ç„¦è™‘ ğŸ˜° |
| **æµå¼** | **0.5s** | 5s | é€å­—æ‰“å­— âŒ¨ï¸ æµç•…ï¼âœ¨ |

**ç”¨æˆ·æ„ŸçŸ¥é€Ÿåº¦æå‡ 10 å€ï¼**

## ğŸ¯ ä»€ä¹ˆæ˜¯æµå¼å“åº”ï¼Ÿ

### éæµå¼æ¨¡å¼

```
ç”¨æˆ·: "ä»‹ç»ä¸€ä¸‹é‡å­è®¡ç®—"
     â†“
ç­‰å¾…... ç­‰å¾…... ç­‰å¾…... (5ç§’)
     â†“
åŠ©æ‰‹: "é‡å­è®¡ç®—æ˜¯åˆ©ç”¨é‡å­åŠ›å­¦åŸç†è¿›è¡Œè®¡ç®—çš„æ–°å‹è®¡ç®—æ–¹å¼..."
      (ä¸€æ¬¡æ€§æ˜¾ç¤ºå…¨éƒ¨)
```

### æµå¼æ¨¡å¼

```
ç”¨æˆ·: "ä»‹ç»ä¸€ä¸‹é‡å­è®¡ç®—"
     â†“ 0.5s
åŠ©æ‰‹: "é‡å­è®¡ç®—"
     â†“ 0.6s
åŠ©æ‰‹: "é‡å­è®¡ç®—æ˜¯åˆ©ç”¨"
     â†“ 0.7s
åŠ©æ‰‹: "é‡å­è®¡ç®—æ˜¯åˆ©ç”¨é‡å­åŠ›å­¦åŸç†"
     â†“ 0.8s
åŠ©æ‰‹: "é‡å­è®¡ç®—æ˜¯åˆ©ç”¨é‡å­åŠ›å­¦åŸç†è¿›è¡Œè®¡ç®—çš„"
     â†“ (é€å­—æ˜¾ç¤ºï¼Œç›´åˆ°å®Œæˆ)
```

**å°±åƒçœŸäººæ‰“å­—ä¸€æ ·è‡ªç„¶ï¼**

## ğŸ—ï¸ æŠ€æœ¯æ¶æ„

### æ•°æ®æµå‘

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              React Frontend                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Messages State                      â”‚    â”‚
â”‚  â”‚  [                                   â”‚    â”‚
â”‚  â”‚    {role: 'user', content: 'ä½ å¥½'},  â”‚    â”‚
â”‚  â”‚    {role: 'assistant', content: 'ä½ '} â”‚â—„â”€â”â”‚
â”‚  â”‚  ]                                   â”‚  â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚â”‚
â”‚         â–²                                  â”‚â”‚
â”‚         â”‚ å®æ—¶æ›´æ–°                         â”‚â”‚
â”‚         â”‚                                  â”‚â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚â”‚
â”‚  â”‚  Event Listeners                    â”‚  â”‚â”‚
â”‚  â”‚  â€¢ chat-chunk  â†’ è¿½åŠ æ–‡æœ¬           â”‚â”€â”€â”˜â”‚
â”‚  â”‚  â€¢ chat-done   â†’ ç»“æŸæ ‡è®°           â”‚   â”‚
â”‚  â”‚  â€¢ chat-error  â†’ é”™è¯¯å¤„ç†           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â–²
                    â”‚ Tauri Events
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Rust Backend                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Stream Reader Thread                â”‚    â”‚
â”‚  â”‚  loop {                              â”‚    â”‚
â”‚  â”‚    line = stdout.read_line()         â”‚    â”‚
â”‚  â”‚    chunk = parse_json(line)          â”‚    â”‚
â”‚  â”‚    window.emit(chunk.type, chunk)    â”‚    â”‚
â”‚  â”‚  }                                   â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚         â–²                                     â”‚
â”‚         â”‚ stdin/stdout                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Python Daemon                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  async def handle_chat_stream():     â”‚    â”‚
â”‚  â”‚    async for sentence in             â”‚    â”‚
â”‚  â”‚        backend.chat_stream(text):    â”‚    â”‚
â”‚  â”‚      print({"type":"chunk",          â”‚    â”‚
â”‚  â”‚             "content":sentence})      â”‚    â”‚
â”‚  â”‚    print({"type":"done"})            â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚         â–²                                     â”‚
â”‚         â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  LLM Backend (Ollama/Claude)        â”‚    â”‚
â”‚  â”‚  â€¢ æµå¼ç”Ÿæˆæ–‡æœ¬                      â”‚    â”‚
â”‚  â”‚  â€¢ æŒ‰å¥å­åˆ†å‰²                        â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”„ å·¥ä½œæµç¨‹è¯¦è§£

### 1. ç”¨æˆ·å‘é€æ¶ˆæ¯

```typescript
// å‰ç«¯ App.tsx
const handleSendText = async () => {
  // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ° UI
  setMessages([...messages, {
    role: 'user',
    content: userInput
  }]);

  // è°ƒç”¨æµå¼ APIï¼ˆé»˜è®¤å¯ç”¨ï¼‰
  await chatGenerator(userInput);  // useStreaming=true
};
```

### 2. React ç›‘å¬æµå¼äº‹ä»¶

```typescript
// useTauriAPI.ts
const chatStream = async (text: string) => {
  let fullResponse = '';
  let messageAdded = false;

  // ç›‘å¬æ–‡æœ¬ç‰‡æ®µ
  listen('chat-chunk', (event) => {
    fullResponse += event.payload;

    // å®æ—¶æ›´æ–° UI
    setMessages(prev => {
      if (!messageAdded) {
        // ç¬¬ä¸€æ¬¡ï¼Œæ·»åŠ æ–°æ¶ˆæ¯
        return [...prev, {role: 'assistant', content: fullResponse}];
      } else {
        // åç»­ï¼Œæ›´æ–°æœ€åä¸€æ¡æ¶ˆæ¯
        prev[prev.length-1].content = fullResponse;
        return [...prev];
      }
    });
  });

  // ç›‘å¬å®Œæˆäº‹ä»¶
  listen('chat-done', () => {
    console.log('Streamå®Œæˆ');
  });

  // è°ƒç”¨ Rust
  await invoke('chat_llm_stream', { text });
};
```

### 3. Rust å¤„ç†æµå¼è¯·æ±‚

```rust
// lib.rs
#[tauri::command]
async fn chat_llm_stream(window: Window, text: String) {
    // åœ¨ç‹¬ç«‹çº¿ç¨‹ä¸­å¤„ç†
    std::thread::spawn(move || {
        // å‘é€å‘½ä»¤åˆ° Python
        daemon.stdin.write('{"command":"chat_stream","args":{"text":"..."}}\n');

        // å¾ªç¯è¯»å–æµå¼è¾“å‡º
        loop {
            let line = daemon.stdout.read_line();
            let chunk = parse_json(line);

            match chunk.type {
                "chunk" => window.emit("chat-chunk", chunk.content),
                "done" => { window.emit("chat-done", ()); break; }
                "error" => { window.emit("chat-error", chunk.error); break; }
            }
        }
    });
}
```

### 4. Python å®ˆæŠ¤è¿›ç¨‹æµå¼ç”Ÿæˆ

```python
# worker_daemon.py
async def handle_chat_stream(self, text: str):
    backend = self.assistant.load_llm()

    # æµå¼ç”Ÿæˆï¼ˆOllama/Claude åŸç”Ÿæ”¯æŒï¼‰
    async for sentence in backend.chat_stream(text):
        # ç«‹å³è¾“å‡ºåˆ° stdout
        print(json.dumps({
            "type": "chunk",
            "content": sentence
        }), flush=True)

    # å‘é€å®Œæˆæ ‡è®°
    print(json.dumps({"type": "done"}), flush=True)
```

### 5. LLM åï¿½ï¿½æµå¼è¾“å‡º

```python
# backends.py - OllamaBackend
async def chat_stream(self, user_input: str):
    """æµå¼ç”Ÿæˆå“åº”ï¼ˆæŒ‰å¥å­ï¼‰"""
    response = await ollama.AsyncClient().chat(
        model=self.model,
        messages=self.history + [{"role": "user", "content": user_input}],
        stream=True  # å¯ç”¨æµå¼
    )

    buffer = ""
    async for chunk in response:
        content = chunk['message']['content']
        buffer += content

        # æ£€æµ‹å¥å­ç»“æŸ
        if self._is_sentence_end(buffer):
            yield buffer
            buffer = ""

    if buffer:
        yield buffer
```

## ğŸ“‚ ä¿®æ”¹çš„æ–‡ä»¶

### æ–°å¢åŠŸèƒ½

```diff
worker_daemon.py:
+ async def handle_chat_stream(self, text: str)
+ æµå¼è¾“å‡ºæ ¼å¼ï¼š{"type":"chunk", "content":"..."}

lib.rs:
+ #[tauri::command]
+ async fn chat_llm_stream(window: Window, text: String)
+ ç‹¬ç«‹çº¿ç¨‹è¯»å–æµå¼è¾“å‡º

useTauriAPI.ts:
+ const chatStream = async (text: string)
+ ç›‘å¬ chat-chunk, chat-done, chat-error äº‹ä»¶
+ å®æ—¶æ›´æ–° messages state
```

## ğŸ¨ ç”¨æˆ·ç•Œé¢æ•ˆæœ

### æ‰“å­—æœºæ•ˆæœ

```
ç”¨æˆ·å‘é€ï¼šä»‹ç»ä¸€ä¸‹é‡å­è®¡ç®—

[0.5s] åŠ©æ‰‹: é‡
[0.6s] åŠ©æ‰‹: é‡å­è®¡ç®—
[0.7s] åŠ©æ‰‹: é‡å­è®¡ç®—æ˜¯ä¸€ç§
[0.8s] åŠ©æ‰‹: é‡å­è®¡ç®—æ˜¯ä¸€ç§åˆ©ç”¨é‡å­åŠ›å­¦
[1.0s] åŠ©æ‰‹: é‡å­è®¡ç®—æ˜¯ä¸€ç§åˆ©ç”¨é‡å­åŠ›å­¦åŸç†è¿›è¡Œè®¡ç®—çš„æŠ€æœ¯
[...] (é€å­—æ˜¾ç¤º)
```

### è§†è§‰åé¦ˆ

- âœ… å®æ—¶æ–‡å­—è¿½åŠ 
- âœ… å…‰æ ‡é—ªçƒåŠ¨ç”»
- âœ… æ¶ˆæ¯è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
- âœ… æµç•…çš„æ‰“å­—æœºæ•ˆæœ

## âš™ï¸ é…ç½®é€‰é¡¹

### å¯ç”¨/ç¦ç”¨æµå¼

```typescript
// useTauriAPI.ts
// é»˜è®¤å¯ç”¨æµå¼
await chatGenerator(text);  // useStreaming=true

// ç¦ç”¨æµå¼ï¼ˆä¸€æ¬¡æ€§è¿”å›ï¼‰
await chatGenerator(text, 'auto', false);
```

### å‰ç«¯ UI è®¾ç½®

```typescript
// App.tsx
const [useStreaming, setUseStreaming] = useState(true);

<label>
  <input
    type="checkbox"
    checked={useStreaming}
    onChange={e => setUseStreaming(e.target.checked)}
  />
  å¯ç”¨æµå¼å“åº”
</label>
```

## ğŸ› æ•…éšœæ’æŸ¥

### é—®é¢˜ 1ï¼šæµå¼è¾“å‡ºå¡ä½

**ç—‡çŠ¶**ï¼šæ–‡å­—æ˜¾ç¤ºåˆ°ä¸€åŠåœæ­¢

**åŸå› **ï¼š
- Python å®ˆæŠ¤è¿›ç¨‹å´©æºƒ
- Rust è¯»å–è¶…æ—¶
- ç½‘ç»œé—®é¢˜ï¼ˆClaude APIï¼‰

**è§£å†³**ï¼š
```bash
# æŸ¥çœ‹å®ˆæŠ¤è¿›ç¨‹æ—¥å¿—
# (Tauri ç»ˆç«¯ä¼šæ˜¾ç¤º Python stderr)

# æµ‹è¯•å®ˆæŠ¤è¿›ç¨‹
python3 test_daemon.py

# æ£€æŸ¥ Ollama çŠ¶æ€
curl http://localhost:11434/api/generate -d '{"model":"qwen2.5:1.5b","prompt":"hello","stream":true}'
```

### é—®é¢˜ 2ï¼šæµå¼äº‹ä»¶æœªè§¦å‘

**ç—‡çŠ¶**ï¼šUI æ— ååº”ï¼Œä½†æ§åˆ¶å°æœ‰æ—¥å¿—

**åŸå› **ï¼šTauri äº‹ä»¶ç›‘å¬å™¨æœªæ³¨å†Œ

**è§£å†³**ï¼š
```typescript
// ç¡®ä¿åœ¨ç»„ä»¶ mount æ—¶ç›‘å¬
useEffect(() => {
  // ç›‘å¬æµå¼äº‹ä»¶
  const unlisten = listen('chat-chunk', ...);
  return () => unlisten();
}, []);
```

### é—®é¢˜ 3ï¼šæµå¼æ€§èƒ½å·®

**ç—‡çŠ¶**ï¼šUI æ›´æ–°å¡é¡¿

**ä¼˜åŒ–æ–¹æ¡ˆ**ï¼š
```typescript
// 1. èŠ‚æµæ›´æ–°ï¼ˆæ¯ 100ms æ›´æ–°ä¸€æ¬¡ï¼‰
let buffer = '';
let timer = null;

listen('chat-chunk', (event) => {
  buffer += event.payload;

  if (!timer) {
    timer = setTimeout(() => {
      setMessages(...); // æ›´æ–° UI
      timer = null;
    }, 100);
  }
});

// 2. ä½¿ç”¨ useTransitionï¼ˆReact 18+ï¼‰
const [isPending, startTransition] = useTransition();
startTransition(() => {
  setMessages(...);
});
```

## ğŸ“ˆ æ€§èƒ½å¯¹æ¯”

### å“åº”æ—¶é—´

| é˜¶æ®µ | éæµå¼ | æµå¼ | æ”¹è¿› |
|------|--------|------|------|
| é¦–å­—æ˜¾ç¤º | 5s | 0.5s | **10x** |
| å®Œæ•´å“åº” | 5s | 5s | - |
| ç”¨æˆ·æ„ŸçŸ¥ | æ…¢ ğŸ˜° | å¿« âœ¨ | **æµç•…ï¼** |

### å†…å­˜å ç”¨

```yaml
éæµå¼:
  - ä¸€æ¬¡æ€§åŠ è½½å®Œæ•´å“åº”åˆ°å†…å­˜
  - å³°å€¼: ~100MB (å¤§å“åº”)

æµå¼:
  - é€å¥å¤„ç†ï¼Œç«‹å³é‡Šæ”¾
  - å³°å€¼: ~10MB
  - èŠ‚çœ 90% å†…å­˜ï¼
```

## ğŸš€ åç»­ä¼˜åŒ–ï¼ˆå¯é€‰ï¼‰

### 1. è¾¹è¯´è¾¹æ’­ï¼ˆTTS æµå¼ï¼‰

```python
# æœªæ¥åŠŸèƒ½
async def handle_chat_tts_stream(self, text: str):
    async for sentence in backend.chat_stream(text):
        # ç«‹å³ç”Ÿæˆ TTS
        audio = await generate_tts(sentence)
        print({"type":"audio", "path": audio})
        # å‰ç«¯æ”¶åˆ°éŸ³é¢‘å°±æ’­æ”¾ï¼Œæ— éœ€ç­‰å¾…å…¨éƒ¨ç”Ÿæˆ
```

### 2. æ‰“æ–­åŠŸèƒ½

```typescript
// ç”¨æˆ·å¯ä»¥æ‰“æ–­ LLM ç”Ÿæˆ
const stopStream = () => {
  invoke('chat_stream_stop');
};
```

### 3. æµå¼é‡è¯•

```typescript
// ç½‘ç»œä¸­æ–­è‡ªåŠ¨é‡è¯•
if (error.type === 'network') {
  retryStream(lastChunkId);
}
```

## ğŸ“ æ€»ç»“

æµå¼å“åº”å¸¦æ¥çš„æ”¹è¿›ï¼š

âœ… **ç”¨æˆ·æ„ŸçŸ¥é€Ÿåº¦æå‡ 10 å€**ï¼ˆé¦–å­—æ˜¾ç¤ºä» 5s â†’ 0.5sï¼‰
âœ… **æ‰“å­—æœºæ•ˆæœè‡ªç„¶æµç•…**ï¼ˆé€å­—æ˜¾ç¤ºï¼‰
âœ… **å†…å­˜å ç”¨å‡å°‘ 90%**ï¼ˆé€å¥å¤„ç†ï¼‰
âœ… **æ”¯æŒè¶…é•¿å›å¤**ï¼ˆæ— éœ€ä¸€æ¬¡æ€§åŠ è½½ï¼‰
âœ… **å…¼å®¹éæµå¼æ¨¡å¼**ï¼ˆè‡ªåŠ¨é™çº§ï¼‰

---

**äº«å—å¦‚ä¸èˆ¬é¡ºæ»‘çš„å¯¹è¯ä½“éªŒï¼** ğŸŒŠâœ¨
