# Speekium 产品交互设计文档

## 1. 产品概述

Speekium 是一款智能语音助手应用，支持两种核心维度的工作模式组合：

### 1.1 工作模式（2种）
- **对话模式**：ASR（语音识别）+ LLM（大语言模型）+ TTS（语音合成）
  - 完整的语音对话体验
  - 听得懂、能思考、会说出来

- **文字输入模式**：ASR + 模拟键盘粘贴
  - 语音转文字后直接输入到当前焦点应用
  - 适合快速文字录入场景

### 1.2 录音模式（2种）
- **按键录音**：按住快捷键开始录音，松开快捷键结束录音
  - 主动控制，精准控制录音时长
  - 适合明确知道要说什么的场景

- **自动检测**：持续监听麦克风，VAD检测到声音后开始录音，静音后自动结束
  - 被动触发，无需手动操作
  - 适合持续对话场景

### 1.3 四种组合模式

| 模式 | 工作模式 | 录音模式 | 简称 | 典型场景 |
|------|---------|---------|------|---------|
| A | 对话模式 | 按键录音 | 对话+按键 | 问答助手、翻译助手 |
| B | 文字输入 | 按键录音 | 文字+按键 | 快速文字录入、即时通讯 |
| C | 对话模式 | 自动检测 | 对话+自动 | 持续对话、语音助理 |
| D | 文字输入 | 自动检测 | 文字+自动 | 连续文字输入、听写 |

---

## 2. 用户场景与推荐配置

### 2.1 模式A：对话模式 + 按键录音
**典型用户**：
- 翻译助手用户（按住说话→翻译→听到翻译结果）
- 问答助手用户（按住提问→思考→语音回答）

**推荐配置**：
- 默认快捷键：`Alt+3` 按住录音
- PTT悬浮窗：显示
- TTS输出：启用

### 2.2 模式B：文字输入 + 按键录音
**典型用户**：
- 即时通讯用户（微信、钉钉等）
- 快速笔记用户
- 代码注释编写者

**推荐配置**：
- 默认快捷键：`Alt+3` 按住录音
- PTT悬浮窗：隐藏
- TTS输出：禁用

### 2.3 模式C：对话模式 + 自动检测
**典型用户**：
- 智能助理用户（类似 Siri、Alexa）
- 持续对话场景（访谈、会议记录）

**推荐配置**：
- 自动启动：应用启动后自动开始监听
- PTT悬浮窗：显示，显示"正在监听"状态
- TTS输出：启用
- VAD灵敏度：中等

### 2.4 模式D：文字输入 + 自动检测
**典型用户**：
- 长文本听写用户（文章写作、报告编写）
- 特殊需求用户（手部不便、语音打字）

**推荐配置**：
- 自动启动：应用启动后自动开始监听
- PTT悬浮窗：显示，显示"正在监听"状态
- TTS输出：禁用
- VAD灵敏度：高（避免过早停止录音）

---

## 3. 交互流程设计

### 3.1 模式A：对话+按键录音流程

```
[空闲状态]
    ↓ 用户按住 Alt+3
[正在录音] → PTT悬浮窗显示"正在录音"
    ↓ 用户说话
    ↓ 用户松开 Alt+3
[录音结束] → 上传音频到后端
    ↓
[ASR识别中] → PTT悬浮窗显示"识别中"
    ↓
[LLM思考中] → PTT悬浮窗显示"思考中"
    ↓
[TTS生成中] → PTT悬浮窗显示"生成中"
    ↓
[播放回答] → PTT悬浮窗显示"播放中"
    ↓
[空闲状态]
```

### 3.2 模式B：文字输入+按键录音流程

```
[空闲状态]
    ↓ 用户按住 Alt+3
[正在录音] → PTT悬浮窗显示"正在录音"
    ↓ 用户说话
    ↓ 用户松开 Alt+3
[录音结束] → 上传音频到后端
    ↓
[ASR识别中] → PTT悬浮窗显示"识别中"
    ↓
[文字输入] → 自动粘贴到当前焦点应用
    ↓ Toast提示"已输入识别结果"
[空闲状态]
```

### 3.3 模式C：对话+自动检测流程

```
[空闲状态]
    ↓ 应用启动（自动进入监听）
[正在监听] → PTT悬浮窗显示"正在监听..."
    ↓ VAD检测到声音
[正在录音] → PTT悬浮窗显示"正在录音"
    ↓ 持续说话...
    ↓ 检测到静音（如1.5秒无声音）
[录音结束] → 上传音频到后端
    ↓
[ASR识别中] → PTT悬浮窗显示"识别中"
    ↓
[LLM思考中] → PTT悬浮窗显示"思考中"
    ↓
[TTS生成中] → PTT悬浮窗显示"生成中"
    ↓
[播放回答] → PTT悬浮窗显示"播放中"
    ↓
[正在监听] → 自动回到监听状态
```

### 3.4 模式D：文字输入+自动检测流程

```
[空闲状态]
    ↓ 应用启动（自动进入监听）
[正在监听] → PTT悬浮窗显示"正在监听..."
    ↓ VAD检测到声音
[正在录音] → PTT悬浮窗显示"正在录音"
    ↓ 持续说话...
    ↓ 检测到静音（如1.5秒无声音）
[录音结束] → 上传音频到后端
    ↓
[ASR识别中] → PTT悬浮窗显示"识别中"
    ↓
[文字输入] → 自动粘贴到当前焦点应用
    ↓ Toast提示"已输入识别结果"
[正在监听] → 自动回到监听状态
```

---

## 4. 核心交互边界处理

### 4.1 工作模式切换边界

**场景1：用户正在对话中（LLM思考/TTS生成）切换工作模式**

| 当前模式 | 切换到 | 处理策略 |
|---------|--------|---------|
| 对话模式 | 文字输入 | ✅ 立即停止当前处理<br>✅ 如果正在播放TTS，立即停止<br>✅ Toast提示"已切换到文字输入模式" |
| 文字输入 | 对话模式 | ✅ 立即停止当前处理<br>✅ Toast提示"已切换到对话模式" |

**场景2：用户正在录音中切换工作模式**

| 当前模式 | 切换到 | 处理策略 |
|---------|--------|---------|
| 任意模式 | 任意模式 | ⚠️ 等待当前录音完成<br>✅ 完成ASR识别<br>⚠️ 如果切换到对话模式，跳过LLM+TTS<br>✅ 使用新模式处理后续流程 |

**场景3：用户正在ASR识别中切换工作模式**

| 当前模式 | 切换到 | 处理策略 |
|---------|--------|---------|
| 对话模式 | 文字输入 | ✅ 等待ASR完成<br>✅ 使用新模式（文字输入）处理识别结果 |
| 文字输入 | 对话模式 | ✅ 等待ASR完成<br>✅ 使用新模式（对话模式）处理识别结果 |

### 4.2 录音模式切换边界

**场景1：从按键录音切换到自动检测**

| 当前状态 | 处理策略 |
|---------|---------|
| 空闲状态 | ✅ 立即切换<br>✅ 开始自动监听<br>✅ Toast提示"已切换到自动检测" |
| 正在录音（按键） | 🚫 立即停止录音<br>✅ 丢弃当前录音<br>✅ 切换到自动监听<br>✅ Toast提示"已切换到自动检测" |
| 正在监听（自动） | ℹ️ 无效操作（已经是自动检测） |

**场景2：从自动检测切换到按键录音**

| 当前状态 | 处理策略 |
|---------|---------|
| 正在监听 | ✅ 立即停止监听<br>✅ 切换到按键模式<br>✅ Toast提示"已切换到按键录音" |
| 正在录音（自动检测到声音） | 🚫 立即停止录音<br>✅ 丢弃当前录音<br>✅ 切换到按键模式<br>✅ Toast提示"已切换到按键录音" |
| 空闲状态 | ℹ️ 无效操作（已经是按键模式） |

### 4.3 组合模式切换边界

**场景：工作模式和录音模式同时切换**

| 优先级 | 处理策略 |
|-------|---------|
| 🥇 用户主动切换 | 立即响应，所有正在进行的操作按上述边界处理 |
| 🥈 自动流程 | ASR/LLM/TTS流程可被模式切换中断 |
| 🥈 录音操作 | 录音完成后才应用新模式（保证数据完整性） |

---

## 5. 状态机设计

### 5.1 应用状态机

```
┌─────────────────────────────────────────────────────────────┐
│                      Speekium 状态机                          │
└─────────────────────────────────────────────────────────────┘

                           [应用启动]
                              ↓
                         [检查配置]
                              ↓
                    ┌─────────┴─────────┐
                    ↓                   ↓
              [自动检测模式]        [按键录音模式]
              (自动进入监听)        (等待按键)
                    ↓                   ↓
              [正在监听]            [等待按键]
                    ↓                   ↓
              (检测到声音)         (按住Alt+3)
                    ↓                   ↓
              [正在录音] ←─────────→ [正在录音]
                    │                   │
              (检测到静音)         (松开Alt+3)
                    ↓                   ↓
              [录音结束] ←─────────→ [录音结束]
                    ↓                   ↓
              [ASR识别中] ←─────────→ [ASR识别中]
                    ↓                   ↓
              ┌────┴────┐         ┌────┴────┐
              ↓         ↓         ↓         ↓
        [对话模式] [文字输入] [对话模式] [文字输入]
              ↓         ↓         ↓         ↓
         [LLM思考]  [直接输出] [LLM思考]  [直接输出]
              ↓         ↓         ↓         ↓
         [TTS生成]  [粘贴文本] [TTS生成]  [粘贴文本]
              ↓         ↓         ↓         ↓
         [播放回答] [完成Toast] [播放回答] [完成Toast]
              ↓         ↓         ↓         ↓
              └────┬────┘         └────┬────┘
                   ↓                   ↓
              [正在监听]            [等待按键]
                   ↑                   ↑
                   └─────────┬─────────┘
                             ↓
                      [模式切换/退出]
```

### 5.2 中断优先级

| 优先级 | 中断源 | 可中断状态 | 说明 |
|-------|--------|-----------|------|
| 1（最高） | 用户切换模式 | 所有状态 | 立即响应用户模式切换 |
| 2 | 用户手动停止录音 | 正在录音 | 立即停止录音并丢弃 |
| 3 | 应用退出 | 所有状态 | 等待当前录音完成，优雅退出 |
| 4 | Daemon重启 | 正在录音 | 等待录音完成后重启 |
| 5（最低） | 自动流程 | ASR/LLM/TTS | 可被模式切换中断 |

---

## 6. 用户反馈设计

### 6.1 Toast通知

| 触发场景 | Toast内容 | 持续时间 |
|---------|----------|---------|
| 切换工作模式 | "已切换到对话模式"<br>"已切换到文字输入模式" | 2秒 |
| 切换录音模式 | "已切换到按键录音"<br>"已切换到自动检测" | 2秒 |
| 文字输入完成 | "已输入识别结果" | 2秒 |
| 录音被中断 | "录音已取消" | 2秒 |
| ASR失败 | "语音识别失败，请重试" | 3秒 |
| LLM失败 | "AI处理失败，请重试" | 3秒 |
| TTS失败 | "语音生成失败，请重试" | 3秒 |

### 6.2 PTT悬浮窗状态

| 状态 | 显示内容 | 视觉效果 |
|------|---------|---------|
| 空闲（按键模式） | "按住 Alt+3 开始录音" | 半透明，灰色 |
| 正在录音 | "🎤 正在录音" | 波形动画，红色 |
| ASR识别中 | "🔄 正在识别" | 旋转图标，蓝色 |
| LLM思考中 | "🤔 正在思考" | 脉搏动画，紫色 |
| TTS生成中 | "🔊 正在生成语音" | 波形动画，绿色 |
| 正在播放 | "🔉 正在播放回答" | 波形动画，绿色 |
| 正在监听（自动） | "👂 正在监听..." | 波形动画，蓝色 |
| 检测到声音（自动） | "🎤 检测到声音" | 波形动画，红色 |

### 6.3 声音反馈

| 触发场景 | 声音效果 |
|---------|---------|
| 开始录音 | "滴"（短促） |
| 录音结束 | "滴-滴"（双音） |
| ASR完成 | "叮"（清脆） |
| LLM完成 | "叮"（清脆） |
| TTS开始播放 | "嘟"（柔和） |
| 出现错误 | "嗡"（低沉） |

---

## 7. 推荐默认配置

### 7.1 首次使用默认配置

```
工作模式：对话模式
录音模式：按键录音
快捷键：Alt+3（按住录音）
PTT悬浮窗：显示
TTS输出：启用
```

**原因**：
- 对话模式是最完整的功能展示
- 按键录音最直观，用户主动控制
- PTT悬浮窗提供明确的状态反馈
- TTS输出让用户体验完整对话流程

### 7.2 配置持久化

```typescript
interface AppConfig {
  workMode: 'conversation' | 'text-input';      // 工作模式
  recordingMode: 'push-to-talk' | 'continuous'; // 录音模式
  hotkey: string;                                // 快捷键，默认 'Alt+3'
  pttOverlay: boolean;                           // PTT悬浮窗显示
  ttsEnabled: boolean;                           // TTS输出启用
  vadSensitivity: number;                        // VAD灵敏度 (0-1)
}
```

---

## 8. 边界条件决策矩阵

### 8.1 工作模式切换决策

| 当前状态 | 切换工作模式 | 录音中 | ASR中 | LLM中 | TTS中 |
|---------|------------|--------|-------|-------|-------|
| **对话+按键** | → 文字+按键 | ✅ 完成 | ✅ 等待 | 🚫 停止 | 🚫 停止 |
| **文字+按键** | → 对话+按键 | ✅ 完成 | ✅ 等待 | - | - |
| **对话+自动** | → 文字+自动 | ✅ 完成 | ✅ 等待 | 🚫 停止 | 🚫 停止 |
| **文字+自动** | → 对话+自动 | ✅ 完成 | ✅ 等待 | - | - |

图例：✅ 执行操作 | 🚫 停止操作 | - 不适用

### 8.2 录音模式切换决策

| 当前状态 | 切换录音模式 | 监听中 | 录音中 | ASR中 | 后续流程 |
|---------|------------|--------|--------|-------|---------|
| **按键模式** | → 自动模式 | - | 🚫 停止并丢弃 | ✅ 等待 | 用新模式 |
| **自动模式** | → 按键模式 | 🚫 停止监听 | 🚫 停止并丢弃 | ✅ 等待 | 用新模式 |

图例：✅ 执行操作 | 🚫 停止操作 | - 不适用

### 8.3 特殊场景决策

| 场景 | 决策 | 原因 |
|------|------|------|
| 录音中切换录音模式 | 立即停止并丢弃 | 模式改变，数据无法复用 |
| 录音中切换工作模式 | 完成录音，等待ASR | 保证数据完整性 |
| ASR中切换任意模式 | 等待ASR完成 | ASR结果对两种模式都有用 |
| LLM中切换到文字模式 | 立即停止LLM | 文字模式不需要LLM |
| TTS播放中切换模式 | 立即停止TTS | 新模式不需要播放 |
| Daemon重启时 | 等待当前录音完成 | 避免数据丢失 |

---

## 9. 实现建议

### 9.1 技术架构

```
┌────────────────────────────────────────────────────────────┐
│                       前端 (React)                         │
├────────────────────────────────────────────────────────────┤
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │  设置面板     │  │  PTT悬浮窗    │  │  Toast通知   │     │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
│           ↓                ↓                ↓              │
│  ┌───────────────────────────────────────────────────┐    │
│  │            状态管理 (State Machine)                │    │
│  │  workMode + recordingMode + currentStatus         │    │
│  └───────────────────────────────────────────────────┘    │
│           ↓                                                │
│  ┌───────────────────────────────────────────────────┐    │
│  │              Tauri Commands/API                    │    │
│  └───────────────────────────────────────────────────┘    │
└────────────────────────────────────────────────────────────┘
                            ↓
┌────────────────────────────────────────────────────────────┐
│                       后端 (Rust)                          │
├────────────────────────────────────────────────────────────┤
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │ 模式管理      │  │ 录音控制      │  │ 状态机引擎    │     │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
│           ↓                ↓                ↓              │
│  ┌───────────────────────────────────────────────────┐    │
│  │              全局状态 (Mutex)                       │    │
│  │  RECORDING_MODE + WORK_MODE + STATUS              │    │
│  └───────────────────────────────────────────────────┘    │
│           ↓                                                │
│  ┌───────────────────────────────────────────────────┐    │
│  │            Python Daemon (ASR/LLM/TTS)             │    │
│  └───────────────────────────────────────────────────┘    │
└────────────────────────────────────────────────────────────┘
```

### 9.2 关键代码结构

**前端状态管理**：
```typescript
enum WorkMode {
  Conversation = 'conversation',
  TextInput = 'text-input',
}

enum RecordingMode {
  PushToTalk = 'push-to-talk',
  Continuous = 'continuous',
}

enum AppStatus {
  Idle = 'idle',
  Listening = 'listening',      // 自动模式监听中
  Recording = 'recording',      // 录音中
  AsrProcessing = 'asr',        // ASR识别中
  LlmProcessing = 'llm',        // LLM思考中
  TtsProcessing = 'tts',        // TTS生成中
  Playing = 'playing',          // TTS播放中
}

interface AppState {
  workMode: WorkMode;
  recordingMode: RecordingMode;
  currentStatus: AppStatus;
}
```

**后端状态管理**：
```rust
enum WorkMode {
    Conversation,
    TextInput,
}

enum RecordingMode {
    PushToTalk,
    Continuous,
}

// 全局状态
static WORK_MODE: Mutex<WorkMode> = Mutex::new(WorkMode::Conversation);
static RECORDING_MODE: Mutex<RecordingMode> = Mutex::new(RecordingMode::PushToTalk);
static CURRENT_STATUS: Mutex<AppStatus> = Mutex::new(AppStatus::Idle);
```

### 9.3 UI设计建议

**设置面板**：
```
┌─────────────────────────────────────┐
│  设置                               │
├─────────────────────────────────────┤
│  工作模式                            │
│  ⚪ 对话模式 (ASR + LLM + TTS)       │
│  ⚪ 文字输入模式 (ASR + 键盘粘贴)     │
│                                     │
│  录音模式                            │
│  ⚪ 按键录音 (按住 Alt+3)           │
│  ⚪ 自动检测 (VAD持续监听)           │
│                                     │
│  快捷键                              │
│  录音快捷键：[Alt+3]                │
│                                     │
│  其他选项                            │
│  ☑ 显示PTT悬浮窗                    │
│  ☑ 启用TTS语音输出                  │
│  ☑ 启用声音反馈                     │
│                                     │
│  VAD灵敏度：[━━━━━○━━━] 50%        │
│                                     │
│        [取消]        [保存]          │
└─────────────────────────────────────┘
```

**PTT悬浮窗**：
```
┌──────────────────────┐
│  🎤 正在录音          │  ← 录音中
│  ▁▃▅▇▅▃▂            │  ← 波形动画
└──────────────────────┘

┌──────────────────────┐
│  🤔 正在思考          │  ← LLM中
│  ● ● ●              │  ← 脉搏动画
└──────────────────────┘

┌──────────────────────┐
│  👂 正在监听...       │  ← 自动模式监听
│  ▂▃▂▃▂▃▂▃           │  ← 波形动画
└──────────────────────┘
```

### 9.4 快捷键建议

| 快捷键 | 功能 | 说明 |
|-------|------|------|
| `Alt+1` | 切换工作模式 | 对话模式 ↔ 文字输入模式 |
| `Alt+2` | 切换录音模式 | 按键录音 ↔ 自动检测 |
| `Alt+3` | 触发录音（按键模式） | 按住开始录音，松开结束 |
| `Alt+4` | 停止当前操作 | 停止录音/TTS播放/自动监听 |

**快捷键选择原因**：
- 使用 `Alt` 修饰键：避免与 macOS 系统快捷键（如 Cmd+1 切换浏览器标签）冲突
- `Alt+1` / `Alt+2`：简单易记，对应两种模式切换
- `Alt+3`：录音触发键，位置居中易于按住
- `Alt+4`：紧急停止键，符合用户习惯

---

## 10. 未来扩展

### 10.1 可扩展功能

1. **多语言支持**：
   - 中英文混合识别
   - 实时翻译模式

2. **自定义工作流**：
   - 用户自定义 ASR → 后处理 → 输出流程
   - 插件系统支持第三方处理

3. **多设备同步**：
   - 配置云端同步
   - 历史记录跨设备访问

4. **高级VAD配置**：
   - 可调节静音阈值
   - 可调节静音持续时间
   - 个性化VAD模型训练

### 10.2 可配置参数

```typescript
interface AdvancedConfig {
  // VAD 配置
  vadThreshold: number;        // 静音阈值 (0-1)
  vadSilenceDuration: number;  // 静音持续时间 (ms)
  vadSpeechPadding: number;    // 语音前后保留时间 (ms)

  // ASR 配置
  asrLanguage: string;         // 识别语言
  asrModel: string;            // 识别模型

  // LLM 配置
  llmModel: string;            // LLM模型
  llmTemperature: number;      // 温度参数
  llmMaxTokens: number;        // 最大token数

  // TTS 配置
  ttsVoice: string;            // TTS音色
  ttsSpeed: number;            // 播放速度
  ttsVolume: number;           // 音量
}
```

---

## 11. 总结

本产品交互设计文档详细定义了 Speekium 的四种组合模式及其交互流程：

### 11.1 四种模式
- **模式A**：对话模式 + 按键录音（问答助手、翻译助手）
- **模式B**：文字输入 + 按键录音（快速文字录入）
- **模式C**：对话模式 + 自动检测（智能助理、持续对话）
- **模式D**：文字输入 + 自动检测（长文本听写）

### 11.2 核心设计原则

1. **用户优先**：用户主动切换模式立即响应
2. **数据安全**：录音完成后才应用新模式，保证数据完整性
3. **状态清晰**：Toast + PTT悬浮窗 + 声音反馈，三重反馈机制
4. **边界明确**：详细的决策矩阵，覆盖所有边界情况
5. **扩展性强**：状态机架构，易于添加新模式和新功能

### 11.3 推荐实现路径

1. **Phase 1**：实现模式A（对话+按键），作为默认配置
2. **Phase 2**：实现模式B（文字+按键），添加工作模式切换
3. **Phase 3**：实现模式C（对话+自动），添加录音模式切换
4. **Phase 4**：实现模式D（文字+自动），完善所有组合

### 11.4 关键成功指标

- ✅ 模式切换响应时间 < 100ms
- ✅ Toast通知显示准确率 100%
- ✅ PTT悬浮窗状态同步准确率 100%
- ✅ 录音数据丢失率 0%
- ✅ 用户操作学习曲线 < 5分钟

---

**文档版本**：v1.0
**最后更新**：2025-01-15
**作者**：Speekium 产品团队
