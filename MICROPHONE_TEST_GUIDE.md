# 麦克风录音功能测试指南

**测试日期**: 2026-01-09
**测试目的**: 验证语音录音功能和完整的语音对话流程

---

## 📋 测试前准备

### 系统要求

- ✅ macOS 系统（当前测试环境）
- ✅ 麦克风设备可用
- ✅ 麦克风权限已授予

### 服务状态检查

**后端服务器**:
```bash
curl http://127.0.0.1:8008/health
# 应返回: OK
```

**Tauri 窗口**:
- 确认窗口已打开
- 检查配置加载成功

---

## 🎤 录音 API 端点

### API 规格

**端点**: `POST /api/record`

**请求参数**:
```json
{
  "mode": "continuous",  // 或 "push-to-talk"
  "language": "auto"     // 可选
}
```

**响应格式**:
```json
{
  "success": true,
  "text": "识别的文本内容"
}
```

**错误响应**:
```json
{
  "success": false,
  "error": "错误信息"
}
```

---

## 🧪 测试方案

### 测试 1: API 端点基础测试

**目的**: 验证录音 API 是否可以被调用

**测试步骤**:
1. 打开终端
2. 准备好麦克风
3. 执行测试命令（见下方）
4. 对着麦克风说话
5. 等待录音结束
6. 检查返回结果

**测试命令**:
```bash
# 测试连续录音模式（VAD 自动检测）
curl -X POST http://127.0.0.1:8008/api/record \
  -H "Content-Type: application/json" \
  -d '{"mode":"continuous"}' \
  | jq .
```

**预期结果**:
- 返回 JSON 格式
- `success: true`
- `text` 包含识别的文字

**注意事项**:
- VAD 模式会自动检测语音开始和结束
- 说话结束后保持安静 1-2 秒
- 如果没有检测到语音，会返回 `"No speech detected"`

---

### 测试 2: UI 录音按钮测试

**目的**: 验证 Tauri 窗口中的录音按钮功能

**测试步骤**:
1. 打开 Tauri 窗口
2. 观察左下角的"🎤 录音"按钮
3. 点击录音按钮
4. 观察状态变化：
   - 按钮文本变为"🔴 停止"
   - 按钮变红色
   - 状态栏显示"录音中..."
   - 🔴 "录音中" 徽章出现
5. 对着麦克风说话（例如："你好，今天天气怎么样？"）
6. 等待 VAD 自动检测结束
7. 观察结果

**预期行为**:
- 录音开始：按钮和徽章状态改变
- 语音检测：VAD 自动检测语音活动
- 录音结束：自动停止并发送给 ASR
- 文本识别：显示识别结果
- LLM 处理：自动调用对话 API
- TTS 播放：如果启用自动播放，会朗读回复

**可能的问题**:
- 麦克风权限未授予 → 系统会弹出权限请求
- VAD 阈值过高 → 无法检测到语音
- 网络问题 → API 调用失败

---

### 测试 3: 完整语音对话流程

**目的**: 端到端验证完整的语音交互

**测试场景**:
1. **简单问答**:
   - 说："你好"
   - 期望：识别 → LLM 回复 → TTS 播放

2. **多轮对话**:
   - 说："今天天气怎么样？"
   - 等待回复
   - 继续说："明天呢？"
   - 验证上下文理解

3. **长句测试**:
   - 说一段较长的话（20-30字）
   - 验证识别准确性

4. **噪音环境**:
   - 在有背景音的环境测试
   - 验证 VAD 抗噪性能

**成功标准**:
- ✅ 语音准确识别（准确率 >80%）
- ✅ LLM 回复相关性高
- ✅ TTS 播放流畅
- ✅ 状态显示准确
- ✅ 错误处理优雅

---

## 🔍 调试检查清单

### 录音不工作

**检查项**:
- [ ] 麦克风是否连接？
  ```bash
  system_profiler SPAudioDataType | grep -A 5 "Input"
  ```

- [ ] 麦克风权限是否授予？
  - 系统偏好设置 → 安全性与隐私 → 麦克风
  - 确认 Python 或终端有权限

- [ ] 后端服务器是否正常？
  ```bash
  curl http://127.0.0.1:8008/health
  ```

- [ ] 音频设备是否正确配置？
  - 检查系统默认输入设备
  - 确认不是虚拟设备

### 识别不准确

**检查项**:
- [ ] 语音清晰度
  - 说话速度适中
  - 发音清晰
  - 距离麦克风适当

- [ ] VAD 阈值配置
  - 检查 `config.json` 中的 `vad_threshold`
  - 默认 0.7，可调整为 0.5-0.9

- [ ] ASR 模型
  - 确认使用的 ASR 后端
  - 检查模型是否支持中文

### LLM 不回复

**检查项**:
- [ ] Ollama 服务是否运行？
  ```bash
  curl http://localhost:11434/api/tags
  ```

- [ ] 模型是否加载？
  ```bash
  ollama list | grep qwen
  ```

- [ ] 网络连接是否正常？

### TTS 不播放

**检查项**:
- [ ] 自动播放是否启用？
  - 查看 UI 左侧设置面板
  - "自动语音播放" 复选框

- [ ] 音频输出设备是否正常？
  - 检查系统音量
  - 确认输出设备选择

- [ ] TTS API 是否正常？
  ```bash
  curl -X POST http://127.0.0.1:8008/api/tts \
    -H "Content-Type: application/json" \
    -d '{"text":"测试"}' | jq '.success'
  ```

---

## 📊 测试结果记录

### 测试 1: API 端点测试

**执行日期**: ___________

**测试结果**:
- [ ] 成功
- [ ] 失败

**识别文本**: ___________

**错误信息**: ___________

**备注**: ___________

---

### 测试 2: UI 录音按钮

**执行日期**: ___________

**测试结果**:
- [ ] 按钮状态正常
- [ ] 录音启动成功
- [ ] VAD 检测正常
- [ ] 文本识别成功
- [ ] LLM 回复正常
- [ ] TTS 播放成功

**问题记录**: ___________

**备注**: ___________

---

### 测试 3: 完整对话流程

**执行日期**: ___________

**对话轮次**: ___ 轮

**识别准确率**: ____%

**成功标准达成**:
- [ ] 语音识别准确
- [ ] LLM 回复相关
- [ ] TTS 播放流畅
- [ ] 状态显示正确
- [ ] 错误处理优雅

**问题记录**: ___________

---

## 🛠️ 常见问题解决

### 问题 1: 麦克风权限被拒绝

**解决方案**:
1. 打开"系统偏好设置"
2. 进入"安全性与隐私"
3. 选择"麦克风"标签
4. 勾选 Python 或终端应用
5. 重启应用

### 问题 2: VAD 无法检测到语音

**解决方案**:
1. 调整 VAD 阈值
   - 编辑 `config.json`
   - 降低 `vad_threshold` 到 0.5
2. 增大麦克风音量
3. 靠近麦克风说话

### 问题 3: 识别结果为空

**解决方案**:
1. 检查是否有语音活动
2. 延长说话时间（>1秒）
3. 检查 ASR 服务状态
4. 查看后端日志

### 问题 4: 录音一直不停止

**解决方案**:
1. 保持安静 2-3 秒
2. 检查 VAD 配置
3. 手动点击停止按钮（如果有）

---

## 📝 测试总结模板

**测试日期**: ___________
**测试人员**: ___________
**测试环境**: macOS ___________

**功能状态**:
- 录音功能: [ ] 正常 [ ] 异常 [ ] 未测试
- 语音识别: [ ] 正常 [ ] 异常 [ ] 未测试
- LLM 对话: [ ] 正常 [ ] 异常 [ ] 未测试
- TTS 播放: [ ] 正常 [ ] 异常 [ ] 未测试

**整体评价**:
- [ ] 可以进入生产
- [ ] 需要优化
- [ ] 存在重大问题

**改进建议**:
___________

**下一步计划**:
___________

---

**文档版本**: 1.0
**最后更新**: 2026-01-09
